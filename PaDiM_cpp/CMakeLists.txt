cmake_minimum_required(VERSION 3.10)
project(PaDiM_cpp)


set(CMAKE_CXX_STANDARD 17)

# å±è”½æ—§ç‰ˆ CUDA å†™æ³•çš„è­¦å‘Š
cmake_policy(SET CMP0146 OLD)

# =========================================================
# ğŸ‘‡ğŸ‘‡ğŸ‘‡ 1. é…ç½®åº“è·¯å¾„ (è¯·æ ¹æ®ä½ çš„å®é™…è§£å‹ä½ç½®ä¿®æ”¹è¿™é‡Œï¼) ğŸ‘‡ğŸ‘‡ğŸ‘‡
# =========================================================

# CUDA è·¯å¾„ 
# (å» D ç›˜çœ‹çœ‹æ˜¯ D:/CUDA è¿˜æ˜¯ D:/CUDA/v11.8ï¼Œè¦æŒ‡å‘åŒ…å« bin/include çš„é‚£ä¸€å±‚)
set(CUDA_TOOLKIT_ROOT_DIR "C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.6") 

# TensorRT è·¯å¾„ (æŒ‡å‘ä½ è§£å‹çš„æ ¹ç›®å½•)
set(TENSORRT_ROOT "E:/Code/PaDiM_cpp/lib/TensorRT-8.6.1.6")

# OpenCV è·¯å¾„ (æŒ‡å‘ build ç›®å½•)
set(OpenCV_DIR "E:/Code/PaDiM_cpp/lib/opencv/build") 

# =========================================================
# ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ”¹ä¸Šé¢å³å¯ï¼Œä¸‹é¢é€šå¸¸ä¸éœ€è¦åŠ¨ ğŸ‘†ğŸ‘†ğŸ‘†
# =========================================================

# è§£å†³ MSVC è¿è¡Œæ—¶åº“å†²çª (å…³é”®ä¿®å¤)
if(MSVC)
    # ç»Ÿä¸€ä½¿ç”¨å¤šçº¿ç¨‹åŠ¨æ€åº“ (/MD Release, /MDd Debug)
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /MD")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} /MDd")
    # å¿½ç•¥ LIBCMT åº“ä»¥è§£å†³å†²çª
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} /NODEFAULTLIB:LIBCMT.lib")
endif()

# 2. æŸ¥æ‰¾åŒ…
find_package(OpenCV REQUIRED)
find_package(CUDA REQUIRED)

# 3. åŒ…å«å¤´æ–‡ä»¶
include_directories(
    "${CUDA_TOOLKIT_ROOT_DIR}/include"  # ğŸ‘ˆ å¿…é¡»æ·»åŠ è¿™ä¸€è¡Œï¼
    ${CUDA_INCLUDE_DIRS}
    "${TENSORRT_ROOT}/include"
    ${OpenCV_INCLUDE_DIRS}
    "src"
)

# 4. é“¾æ¥åº“ç›®å½•
link_directories(
    "${TENSORRT_ROOT}/lib"
)

# 5. æ”¶é›†æºæ–‡ä»¶ (è‡ªåŠ¨æŸ¥æ‰¾ src ä¸‹æ‰€æœ‰çš„ .cpp å’Œ .cu)
file(GLOB_RECURSE SRCS "src/*.cpp" "src/*.cu")

# 6. ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ (ä½¿ç”¨ cuda_add_executable å¤„ç† .cu æ–‡ä»¶)
cuda_add_executable(padim_infer ${SRCS})

# 7. é“¾æ¥ä¾èµ–åº“
target_link_libraries(padim_infer 
    ${OpenCV_LIBS} 
    ${CUDA_LIBRARIES} 
    nvinfer           # TensorRT æ ¸å¿ƒåº“
    nvonnxparser      # ONNX è§£æåº“
)
